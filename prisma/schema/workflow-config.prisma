// WORKFLOW CONFIGURABLE - Metadatos de workflows data-driven
// Este esquema permite definir workflows dinámicamente en BD

// ENUMS ------------------------------------------------
enum EntityType {
  TASK
  REQUEST
}

// ============================================
// CONFIGURACIÓN DE WORKFLOWS (Metadatos)
// ============================================

model WorkflowDefinition {
  id          String   @id @default(uuid())
  code        String   @unique // "task_validation", "task_voting", "request_free_day"
  name        String
  description String?
  entityType  EntityType // TASK o REQUEST
  version     Int      @default(1)
  isActive    Boolean  @default(true)
  
  states      WorkflowState[]
  transitions WorkflowTransition[]
  tasks       Task[]          // Instancias usando este workflow
  requests    Request[]       // Instancias usando este workflow
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([code, version])
  @@index([entityType, isActive])
}

model WorkflowState {
  id          String   @id @default(uuid())
  workflowId  String
  workflow    WorkflowDefinition @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  code        String   // "pending", "in_review", "approved"
  name        String   // "Pendiente", "En revisión"
  color       String   @default("gray") // Para badges UI (amber, blue, green, red, purple)
  order       Int      // Para mostrar en secuencia
  
  isInitial   Boolean  @default(false)
  isFinal     Boolean  @default(false)
  isTerminal  Boolean  @default(false) // No permite salir (cancelled, rejected)
  
  // Configuración específica por tipo de workflow (JSON)
  config      String?  @db.Text // { "requiresComment": true, "timeoutDays": 7 }
  
  transitionsFrom WorkflowTransition[] @relation("FromState")
  transitionsTo   WorkflowTransition[] @relation("ToState")
  
  // Relaciones con instancias
  currentTasks    Task[]     @relation("TaskCurrentState")
  currentRequests Request[]  @relation("RequestCurrentState")
  historyEntries  StateHistory[] @relation("HistoryToState")
  
  @@unique([workflowId, code])
  @@index([workflowId, isInitial])
}

model WorkflowTransition {
  id              String   @id @default(uuid())
  workflowId      String
  workflow        WorkflowDefinition @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  fromStateId     String
  fromState       WorkflowState @relation("FromState", fields: [fromStateId], references: [id], onDelete: Cascade)
  toStateId       String
  toState         WorkflowState @relation("ToState", fields: [toStateId], references: [id], onDelete: Cascade)
  
  // Quién puede ejecutar esta transición (JSON: ["ADMIN", "HEAD", "ASSIGNEE"])
  allowedRoles    String
  
  // Condiciones y acciones
  requiresComment Boolean  @default(false)
  requiresFields  String?  // JSON: ["documentUrl", "justification"]
  autoActions     String?  // JSON: ["create_notification", "update_calendar"]
  
  // Validación custom (opcional)
  validatorCode   String?  // "check_quota", "validate_schedule", etc.
  
  @@index([workflowId, fromStateId])
  @@unique([workflowId, fromStateId, toStateId])
}

// ============================================
// HISTORIAL DE ESTADOS (Auditoría específica de workflow)
// ============================================

model StateHistory {
  id          String   @id @default(uuid())
  
  // Polimórfico: puede ser Task o Request
  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  requestId   String?
  request     Request? @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  fromStateId String
  toStateId   String
  toState     WorkflowState @relation("HistoryToState", fields: [toStateId], references: [id])
  
  actorId     String
  actor       User     @relation(fields: [actorId], references: [id], onDelete: Cascade)
  
  comment     String?  @db.Text
  metadata    String?  @db.Text // Datos adicionales de la transición
  
  createdAt   DateTime @default(now())
  
  @@index([taskId])
  @@index([requestId])
  @@index([actorId])
  @@index([createdAt])
}

// ============================================
// NOTIFICACIONES DE WORKFLOW
// ============================================

model WorkflowNotification {
  id          String   @id @default(uuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  message     String   @db.Text
  type        String   @default("info") // info, success, warning, error
  
  // Relación opcional con entidad
  taskId      String?
  requestId   String?
  
  // Enlaces para navegación
  actionUrl   String?
  actionLabel String?
  
  // Estado
  isRead      Boolean  @default(false)
  readAt      DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([userId, isRead])
  @@index([createdAt])
}
